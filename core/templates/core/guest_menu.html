<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masa {{ table.table_number }} Menüsü - {{ business.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(to bottom right, #e0f2fe, #bae6fd); }
        .cart-item:hover { background-color: #f0f9ff; }
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 10px; position: relative; animation: slideIn 0.3s; }
        @keyframes slideIn { from { top: -50px; opacity: 0; } to { top: 0; opacity: 1; } }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .category-button { transition: all 0.3s ease; border: 1px solid transparent; }
        .category-button.active { background-color: #3b82f6; color: white; border-color: #1d4ed8; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .category-button:hover:not(.active) { background-color: #eff6ff; }
        .product-card { transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .product-card.flash { animation: flash-bg 0.5s ease; }
        @keyframes flash-bg { 0% { background-color: #dcfce7; } 100% { background-color: #ffffff; } }
        #active-order-section { border-top: 2px dashed #60a5fa; margin-top: 2rem; padding-top: 1.5rem; }
        #guest-order-status-container { position: sticky; top: 0; left: 0; right: 0; z-index: 1000; text-align: center; pointer-events: none; }
        .status-message { display: inline-block; padding: 10px 20px; color: white; border-radius: 0 0 8px 8px; margin-top:0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-weight: bold; pointer-events: all; }
        .status-success { background-color: #4CAF50; }
        .status-error { background-color: #f44336; }
        .status-warning { background-color: #FFC107; color: #333; }
        .status-info { background-color: #2196F3; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 min-h-screen p-4 md:p-8">

    <div id="table-uuid-data" data-uuid="{{ table.uuid }}" style="display: none;"></div>
    <input type="hidden" id="current-guest-order-id" value="">
    <div id="guest-order-status-container"></div>

    <div class="container mx-auto max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">{{ business.name }}</h1>
            <h2 class="text-xl md:text-2xl text-gray-600">Masa {{ table.table_number }}</h2>
        </header>

        <div id="active-order-section" class="mb-10 bg-blue-50 p-4 rounded-lg shadow border border-blue-200" style="display: none;">
            <h3 class="text-xl font-semibold mb-3 text-blue-800 flex items-center">
                <i class="fas fa-receipt mr-2"></i> Masanın Mevcut Siparişi
            </h3>
            <div id="active-order-items" class="mb-3 divide-y divide-blue-200"></div>
            <div class="border-t border-blue-200 pt-3 flex justify-between items-center">
                <span class="text-md font-bold text-gray-800">Masa Toplamı:</span>
                <span id="active-order-total" class="text-md font-bold text-blue-700">0.00 TL</span>
            </div>
            <p class="text-xs text-gray-500 mt-2">Yeni ekleyeceğiniz ürünler aşağıdaki sepette görünecektir.</p>
        </div>

        <div id="category-filters" class="mb-6 flex flex-wrap justify-center gap-2">
            <button class="category-button active px-4 py-2 bg-white text-gray-700 rounded-full shadow text-sm font-medium" data-category-id="all">Tümü</button>
        </div>

        <div id="menu-items-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <p id="loading-message" class="text-gray-500 text-center col-span-full">Menü Yükleniyor...</p>
        </div>

        <div id="cart-section" class="mt-12 bg-white p-6 rounded-lg shadow-lg sticky bottom-4 border border-gray-200">
            <h3 class="text-2xl font-semibold mb-4 text-gray-800 flex items-center justify-between">
                <span class="flex items-center"><i class="fas fa-cart-plus mr-2 text-green-600"></i> Yeni Eklenecekler</span>
                <span id="cart-count-badge" class="bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </h3>
            <div id="cart-items" class="mb-4 max-h-60 overflow-y-auto divide-y divide-gray-200 pr-2">
                <p id="empty-cart-message" class="text-gray-500 text-center py-4">Yeni ürün eklemek için menüden seçin.</p>
            </div>
            <div class="border-t border-gray-200 pt-4 flex justify-between items-center">
                <span class="text-lg font-bold text-gray-800">Eklenecek Tutar:</span>
                <span id="cart-total" class="text-lg font-bold text-green-600">0.00 TL</span>
            </div>
            <button id="submit-order-button" class="mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fas fa-check-circle mr-2"></i> Seçilenleri Siparişe Ekle
            </button>
            <p id="order-status-message-local" class="mt-2 text-center text-sm"></p>
        </div>
    </div>

    <div id="variant-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h4 id="modal-item-name" class="text-xl font-semibold mb-4">Ürün Seçenekleri</h4>
            <div id="modal-variants" class="mb-4"></div>
            <div id="modal-extras" class="mb-4"></div>
            <label for="modal-notes" class="block text-sm font-medium text-gray-700 mb-1">Not (isteğe bağlı):</label>
            <textarea id="modal-notes" rows="2" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea>
            <button id="add-to-cart-modal-button" class="mt-4 w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                Sepete Ekle
            </button>
        </div>
    </div>
    
    {{ all_menu_items_data_json|json_script:"all-menu-items-data" }}
    {{ active_order_data_json|json_script:"active-order-data" }}
    {% comment %} Bu değişikliği backend'de de yapmanız gerekecek. Şimdilik geçici bir çözümle devam edelim. {% endcomment %}
    {{ guest_order_api_url|json_script:"guest-order-api-url-data" }}
    {{ csrf_token|json_script:"csrf-token-data" }}

    <script>
        console.log("Guest Menu Script v7 (Optimized - No Fetch) Başladı.");

        // --- Global Değişkenler ---
        let menuDataGlobal = {};
        let categoriesGlobal = [];
        let newCart = [];
        const guestOrderApiUrl = JSON.parse(document.getElementById('guest-order-api-url-data')?.textContent || '""');
        const csrfToken = JSON.parse(document.getElementById('csrf-token-data')?.textContent || '""');
        const tableUuid = document.getElementById('table-uuid-data')?.dataset.uuid;
        
        // --- Element Referansları ---
        const menuContainerEl = document.getElementById('menu-items-container');
        const newCartItemsContainerEl = document.getElementById('cart-items');
        const newCartTotalElementEl = document.getElementById('cart-total');
        const emptyNewCartMessageEl = document.getElementById('empty-cart-message');
        const submitNewOrderButtonEl = document.getElementById('submit-order-button');
        const guestOrderStatusContainerEl = document.getElementById('guest-order-status-container');
        const variantModalEl = document.getElementById('variant-modal');
        const modalItemNameEl = document.getElementById('modal-item-name');
        const modalVariantsContainerEl = document.getElementById('modal-variants');
        const modalExtrasContainerEl = document.getElementById('modal-extras');
        const modalNotesEl = document.getElementById('modal-notes');
        const addToCartModalButtonEl = document.getElementById('add-to-cart-modal-button');
        const categoryFiltersContainerEl = document.getElementById('category-filters');
        const newCartCountBadgeEl = document.getElementById('cart-count-badge');
        const activeOrderSectionEl = document.getElementById('active-order-section');
        const activeOrderItemsContainerEl = document.getElementById('active-order-items');
        const activeOrderTotalElementEl = document.getElementById('active-order-total');

        // --- Yardımcı Fonksiyonlar (Aynı kalabilir) ---
        function displayStatusMessage(message, type = 'info') {
            if (!guestOrderStatusContainerEl) return;
            let className = 'status-info';
            if (type === 'success') className = 'status-success';
            else if (type === 'error') className = 'status-error';
            else if (type === 'warning') className = 'status-warning';
            guestOrderStatusContainerEl.innerHTML = `<div class="status-message ${className}">${message}</div>`;
            setTimeout(() => {
                if (guestOrderStatusContainerEl.firstChild && guestOrderStatusContainerEl.firstChild.textContent === message) {
                    guestOrderStatusContainerEl.innerHTML = '';
                }
            }, 7000);
        }
        
        // Diğer tüm fonksiyonlar (displayCategoryFilters, displayActiveOrder, filterMenuItems, createMenuItemCard, openVariantModal, closeModal, addToNewCart, removeFromNewCart, updateNewCartDisplay, submitNewOrderItems)
        // önceki dosyanızdaki gibi kalabilir. Aşağıya tam hallerini ekliyorum.

        function displayCategoryFilters(categories) {
            if (!categoryFiltersContainerEl) return;
            categoryFiltersContainerEl.querySelectorAll('button:not([data-category-id="all"])').forEach(btn => btn.remove());
            categories?.filter(cat => cat && cat.parent == null).forEach(category => {
                const button = document.createElement('button');
                button.className = 'category-button px-4 py-2 bg-white text-gray-700 rounded-full shadow text-sm font-medium';
                button.dataset.categoryId = category.id.toString();
                button.textContent = category.name;
                categoryFiltersContainerEl.appendChild(button);
            });
        }

        function displayActiveOrder(orderData) {
            if (!activeOrderItemsContainerEl || !activeOrderTotalElementEl || !activeOrderSectionEl) return;
            if (!orderData || !orderData.order_items || orderData.order_items.length === 0) {
                activeOrderSectionEl.style.display = 'none';
                return;
            }
            activeOrderItemsContainerEl.innerHTML = '';
            let total = 0;
            orderData.order_items.forEach(item => {
                const lineTotal = (parseFloat(item.price || 0) * parseInt(item.quantity || 0));
                let extrasText = item.extras?.map(e => e.variant_name).join(', ') ?? '';
                extrasText = extrasText ? `<br><span class="text-xs text-blue-600">Ekstralar: ${extrasText}</span>` : '';
                const itemElement = document.createElement('div');
                itemElement.className = 'py-2 flex justify-between items-start text-sm';
                
                // item.variant.name olarak erişim sağlanmalı
                const variantName = item.variant ? `(${item.variant.name})` : '';

                itemElement.innerHTML = `
                    <div class="flex-grow pr-2">
                        <span class="font-medium text-gray-800">${item.menu_item?.name ?? 'Ürün'} ${variantName} x ${item.quantity}</span>
                        ${extrasText}
                    </div>
                    <span class="font-semibold text-gray-700 whitespace-nowrap">${lineTotal.toFixed(2)} TL</span>`;
                activeOrderItemsContainerEl.appendChild(itemElement);
                total += lineTotal;
            });
            activeOrderTotalElementEl.textContent = `${total.toFixed(2)} TL`;
            activeOrderSectionEl.style.display = 'block';

            if (orderData.status === 'pending_approval') displayStatusMessage(`Siparişiniz (No: ${orderData.id}) onay bekliyor.`, 'warning');
            else if (orderData.status === 'approved') displayStatusMessage(`Siparişiniz (No: ${orderData.id}) onaylandı.`, 'success');
            else if (orderData.status === 'rejected') displayStatusMessage(`Siparişiniz (No: ${orderData.id}) reddedildi.`, 'error');
        }

        function filterMenuItems(categoryId = 'all') {
            if (!menuContainerEl) return;
            const loadingMsg = document.getElementById('loading-message');
            if (loadingMsg) loadingMsg.style.display = 'none';
            
            menuContainerEl.innerHTML = '';
            const itemsToDisplay = categoryId === 'all'
                ? Object.values(menuDataGlobal)
                : Object.values(menuDataGlobal).filter(item => item.category?.id?.toString() === categoryId.toString());
            if (itemsToDisplay.length === 0) {
                menuContainerEl.innerHTML = '<p class="text-gray-500 text-center col-span-full">Bu kategoride ürün bulunamadı.</p>';
                return;
            }
            itemsToDisplay.forEach(item => {
                if (item?.id != null) menuContainerEl.appendChild(createMenuItemCard(item));
            });
            document.querySelectorAll('.category-button').forEach(btn => btn.classList.toggle('active', btn.dataset.categoryId == categoryId.toString()));
        }

        function createMenuItemCard(item) {
            const card = document.createElement('div');
            card.className = 'product-card bg-white rounded-lg shadow overflow-hidden flex flex-col';
            const imageUrl = item.image || item.category?.image;
            const imageContainer = document.createElement('div');
            imageContainer.className = 'h-48 w-full bg-gray-200 flex items-center justify-center overflow-hidden';
            if (imageUrl && imageUrl.startsWith('http')) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = item.name;
                img.className = 'h-full w-full object-cover';
                img.onerror = () => { imageContainer.innerHTML = '<i class="fas fa-utensils text-4xl text-gray-400"></i>'; };
                imageContainer.appendChild(img);
            } else {
                imageContainer.innerHTML = '<i class="fas fa-utensils text-4xl text-gray-400"></i>';
            }
            card.appendChild(imageContainer);
            const content = document.createElement('div');
            content.className = 'p-4 flex flex-col flex-grow';

            let displayPrice = 'Fiyat Yok';
            // Kampanya fiyatını göstermek için price_display alanını kullanıyoruz
            if (item.is_campaign_bundle && item.price_display != null) {
                displayPrice = `${parseFloat(item.price_display).toFixed(2)} TL`;
            } else {
                const firstNormalVariant = item.variants?.find(v => v && !v.is_extra);
                if (firstNormalVariant?.price != null) {
                    displayPrice = `${parseFloat(firstNormalVariant.price).toFixed(2)} TL`;
                } else if (item.variants?.some(v => v && !v.is_extra)) {
                    displayPrice = 'Seçenekli';
                }
            }
            
            content.innerHTML = `<h3 class="text-lg font-semibold text-gray-800 mb-1">${item.name || 'İsimsiz'}</h3><p class="text-sm text-gray-600 mb-3 flex-grow">${item.description || ''}</p><div class="flex justify-between items-center mt-auto"><span class="text-lg font-bold text-blue-600">${displayPrice}</span><button class="add-to-cart-btn bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-full transition duration-300"><i class="fas fa-plus"></i> Ekle</button></div>`;
            card.appendChild(content);
            const actionOnClick = () => {
                const hasNormalVariants = item.variants?.some(v => v && !v.is_extra);
                const hasOnlyExtras = item.variants?.some(v => v && v.is_extra) && !hasNormalVariants;
                if (item.is_campaign_bundle) {
                    addToNewCart(item.id, null, [], null); 
                } else if (hasNormalVariants || hasOnlyExtras) {
                    openVariantModal(item.id);
                } else {
                    addToNewCart(item.id, null, [], null);
                }
            };
            content.querySelector('.add-to-cart-btn').onclick = (e) => { e.stopPropagation(); actionOnClick(); card.classList.add('flash'); setTimeout(() => card.classList.remove('flash'), 500); };
            card.onclick = actionOnClick;
            return card;
        }

        function openVariantModal(itemId) {
            const item = menuDataGlobal[itemId];
            if (!item ) { console.error("Varyant modalı için ürün bulunamadı"); return; }
            if (!modalItemNameEl || !modalVariantsContainerEl || !modalExtrasContainerEl || !modalNotesEl || !addToCartModalButtonEl || !variantModalEl) { console.error("Modal elementlerinden biri bulunamadı!"); return; }
            modalItemNameEl.textContent = item.name;
            modalVariantsContainerEl.innerHTML = ''; modalExtrasContainerEl.innerHTML = ''; modalNotesEl.value = '';
            const normalVariants = item.variants?.filter(v => v && !v.is_extra) || [];
            const extraVariants = item.variants?.filter(v => v && v.is_extra) || [];
            if (normalVariants.length > 0) {
                const title = document.createElement('p'); title.className = 'font-semibold mb-2 text-gray-700'; title.textContent = 'Seçenek:'; modalVariantsContainerEl.appendChild(title);
                normalVariants.forEach((variant, index) => {
                    const label = document.createElement('label'); label.className = 'flex items-center mb-2 cursor-pointer';
                    label.innerHTML = `<input type="radio" name="modal_variant_selection" value="${variant.id}" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" ${index === 0 ? 'checked' : ''}><span class="text-gray-800">${variant.name} - ${parseFloat(variant.price).toFixed(2)} TL</span>`;
                    modalVariantsContainerEl.appendChild(label);
                });
            }
            if (extraVariants.length > 0) {
                const title = document.createElement('p'); title.className = 'font-semibold mb-2 text-gray-700 mt-4'; title.textContent = 'Ekstralar:'; modalExtrasContainerEl.appendChild(title);
                extraVariants.forEach(variant => {
                    const label = document.createElement('label'); label.className = 'flex items-center mb-2 cursor-pointer';
                    label.innerHTML = `<input type="checkbox" name="modal_extra_selection" value="${variant.id}" class="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><span class="text-gray-800">${variant.name} - ${parseFloat(variant.price).toFixed(2)} TL</span>`;
                    modalExtrasContainerEl.appendChild(label);
                });
            }
            addToCartModalButtonEl.onclick = () => {
                const selectedVariantInput = modalVariantsContainerEl.querySelector('input[name="modal_variant_selection"]:checked');
                const selectedVariantId = selectedVariantInput ? parseInt(selectedVariantInput.value) : null;
                if (normalVariants.length > 0 && selectedVariantId === null) { alert("Lütfen bir ana seçenek (varyant) belirtin."); return; }
                const selectedExtraInputs = modalExtrasContainerEl.querySelectorAll('input[name="modal_extra_selection"]:checked');
                const selectedExtraIds = Array.from(selectedExtraInputs).map(input => parseInt(input.value));
                const notes = modalNotesEl.value.trim();
                addToNewCart(itemId, selectedVariantId, selectedExtraIds, notes);
                closeModal();
            };
            variantModalEl.style.display = 'block';
        }
        function closeModal() { if(variantModalEl) variantModalEl.style.display = 'none'; }

        function addToNewCart(itemId, selectedVariantId = null, selectedExtraIds = [], notes = null) {
            const item = menuDataGlobal[itemId];
            if (!item) { console.error(`addToNewCart: Ürün ID ${itemId} bulunamadı!`); return; }

            let mainVariant = null;
            let extras = [];
            let unitPrice = 0;

            if (item.is_campaign_bundle) {
                unitPrice = parseFloat(item.price_display);
            } else {
                if (selectedVariantId !== null && item.variants) {
                    mainVariant = item.variants.find(v => v.id === selectedVariantId && !v.is_extra);
                } else if (item.variants?.some(v => v && !v.is_extra) && selectedVariantId === null) {
                    alert(`Lütfen '${item.name}' için bir ana seçenek belirtin.`);
                    return;
                }
                extras = selectedExtraIds.map(extraId => item.variants?.find(v => v.id === extraId && v.is_extra)).filter(v => v != null);
                unitPrice = parseFloat(mainVariant?.price || 0);
                extras.forEach(extra => { unitPrice += parseFloat(extra.price); });
            }

            const notesStringForId = notes ? notes.replace(/\s+/g, '-').toLowerCase() : 'no-notes';
            const cartId = `${item.id}-${mainVariant?.id ?? 'no-main'}-${extras.map(e => e.id).sort().join('-')}-${notesStringForId}`;
            const existingCartItemIndex = newCart.findIndex(cartItem => cartItem.cartId === cartId);
            
            if (existingCartItemIndex > -1) {
                newCart[existingCartItemIndex].quantity += 1;
            } else {
                newCart.push({ 
                    cartId, 
                    itemId: item.id, 
                    itemName: item.name, 
                    variantId: mainVariant?.id, 
                    variantName: mainVariant?.name, 
                    price: unitPrice, 
                    quantity: 1, 
                    extras: extras.map(e => ({ variant: e.id, quantity: 1 })), // API'nin beklediği format
                    notes 
                });
            }
            updateNewCartDisplay();
        }

        function removeFromNewCart(cartId) {
            const itemIndex = newCart.findIndex(item => item.cartId === cartId);
            if (itemIndex > -1) {
                if (newCart[itemIndex].quantity > 1) { newCart[itemIndex].quantity -= 1; } 
                else { newCart.splice(itemIndex, 1); }
                updateNewCartDisplay();
            }
        }

        function updateNewCartDisplay() {
            if (!newCartItemsContainerEl || !newCartTotalElementEl || !emptyNewCartMessageEl || !newCartCountBadgeEl) return;
            newCartItemsContainerEl.innerHTML = '';
            let total = 0; let totalItems = 0;
            if (newCart.length === 0) { emptyNewCartMessageEl.style.display = 'block'; } 
            else {
                emptyNewCartMessageEl.style.display = 'none';
                newCart.forEach(item => {
                    const extrasText = item.extras?.length > 0 ? `<br><span class="text-xs text-gray-500">Ekstralar: ${item.extras.map(e => menuDataGlobal[item.itemId].variants.find(v=>v.id===e.variant)?.name).join(', ')}</span>` : '';
                    const notesText = item.notes ? `<br><span class="text-xs text-blue-500">Not: ${item.notes}</span>` : '';
                    const itemElement = document.createElement('div');
                    itemElement.className = 'cart-item flex justify-between items-center py-3 text-sm';
                    itemElement.innerHTML = `<div><span class="font-medium text-gray-800">${item.itemName} ${item.variantName ? `(${item.variantName})` : ''}</span>${extrasText}${notesText}</div><div class="flex items-center"><span class="mx-2 font-semibold">${item.quantity} x ${item.price.toFixed(2)} TL</span><button class="remove-from-cart-btn text-red-500 hover:text-red-700 ml-2" data-cart-id="${item.cartId}"><i class="fas fa-minus-circle"></i></button></div>`;
                    newCartItemsContainerEl.appendChild(itemElement);
                    total += item.price * item.quantity;
                    totalItems += item.quantity;
                });
                document.querySelectorAll('.remove-from-cart-btn').forEach(button => { button.onclick = () => removeFromNewCart(button.dataset.cartId); });
            }
            newCartTotalElementEl.textContent = `${total.toFixed(2)} TL`;
            newCartCountBadgeEl.textContent = totalItems.toString();
            if (submitNewOrderButtonEl) submitNewOrderButtonEl.disabled = newCart.length === 0;
        }

        async function submitNewOrderItems() {
            if (newCart.length === 0) { displayStatusMessage('Lütfen önce ürün ekleyin.', 'warning'); return; }
            if (submitNewOrderButtonEl) { submitNewOrderButtonEl.disabled = true; submitNewOrderButtonEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Ekleniyor...'; }

            const orderDataPayload = {
                order_items_data: newCart.map(item => ({
                    menu_item_id: item.itemId,
                    variant_id: item.variantId, 
                    quantity: item.quantity,
                    extras: item.extras 
                })),
            };

            try {
                const response = await fetch(guestOrderApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify(orderDataPayload),
                });
                const responseData = await response.json();
                if (response.ok) {
                    newCart = [];
                    updateNewCartDisplay();
                    displayActiveOrder(responseData);
                    const successMsg = responseData.status === 'pending_approval' ? "Siparişiniz alındı, onay bekleniyor..." : "Ürünler mevcut siparişinize eklendi!";
                    displayStatusMessage(successMsg, responseData.status === 'pending_approval' ? 'warning' : 'success');
                } else {
                    let errorMsgText = `Ürünler eklenemedi (${response.status}).`;
                    if (responseData && responseData.detail) { errorMsgText = responseData.detail; } 
                    else if (responseData) { errorMsgText = JSON.stringify(responseData); }
                    displayStatusMessage(errorMsgText, 'error');
                }
            } catch (error) {
                console.error('Network Error during order submission:', error);
                displayStatusMessage('Yeni ürünler eklenirken bir ağ hatası oluştu.', 'error');
            } finally {
                if (submitNewOrderButtonEl) {
                    submitNewOrderButtonEl.disabled = newCart.length === 0;
                    submitNewOrderButtonEl.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Seçilenleri Siparişe Ekle';
                }
            }
        }

        // --- Ana Başlatma Bloğu ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Gereksiz API çağrısı yapan fonksiyonu kaldırıyoruz.
            // fetchMenuAndActiveOrder(); // Bu satır SİLİNDİ.

            // 2. DOMContentLoaded içinde veriyi doğrudan json_script'lerden okuyoruz.
            try {
                // Backend'den gelen verileri parse et
                const menuDataJson = JSON.parse(document.getElementById('all-menu-items-data')?.textContent || '[]');
                const activeOrderJson = JSON.parse(document.getElementById('active-order-data')?.textContent || 'null');
                
                // Kategori verisini geçici olarak menuData'dan türetelim (backend'de düzeltilene kadar)
                const allCategories = menuDataJson.map(item => item.category).filter(Boolean);
                const uniqueCategories = Array.from(new Map(allCategories.map(item => [item['id'], item])).values());
                categoriesGlobal = uniqueCategories;
                
                menuDataGlobal = menuDataJson.reduce((acc, item) => {
                    if (item?.id != null) acc[item.id] = item;
                    return acc;
                }, {});
                
                // Veri okunduktan sonra arayüzü çiz
                displayCategoryFilters(categoriesGlobal);
                displayActiveOrder(activeOrderJson);
                filterMenuItems();
                updateNewCartDisplay();

            } catch(e) {
                console.error("Başlangıç verisi okunurken veya işlenirken hata:", e);
                const errorMsg = "Menü yüklenemedi: Sayfa verileri okunamadı.";
                if (menuContainerEl) menuContainerEl.innerHTML = `<p class="text-red-500 text-center col-span-full">${errorMsg}</p>`;
                displayStatusMessage(errorMsg, "error");
            }
            
            // --- Olay Dinleyicileri ---
            if (categoryFiltersContainerEl) categoryFiltersContainerEl.addEventListener('click', (e) => {
                const btn = e.target.closest('button.category-button');
                if (btn?.dataset.categoryId) filterMenuItems(btn.dataset.categoryId);
            });
            if (submitNewOrderButtonEl) submitNewOrderButtonEl.addEventListener('click', submitNewOrderItems);
            if (variantModalEl) window.onclick = (e) => { if (e.target == variantModalEl) closeModal(); }

            // --- Socket.IO Bağlantısı ---
            if (tableUuid) {
                const socket = io(`${window.location.protocol}//${window.location.host}`, { path: '/socket.io/', transports: ['websocket', 'polling'] });
                socket.on('connect', () => {
                    console.log('Misafir: Socket.IO bağlandı.');
                    socket.emit('join_guest_table_room', { table_uuid: tableUuid });
                });
                socket.on('order_update_for_guest_table', (data) => {
                    console.log('Misafir için sipariş güncellemesi:', data);
                    // Sayfayı yeniden yüklemek yerine, sadece veriyi güncelleyelim.
                    if (data?.updated_order_data) {
                         displayActiveOrder(data.updated_order_data);
                    }
                    if (data?.message) {
                        let msgType = (data.event_type?.includes('approved') || data.event_type?.includes('delivered')) ? 'success' : ((data.event_type?.includes('rejected')) ? 'error' : 'warning');
                        displayStatusMessage(data.message, msgType);
                    }
                });
            }
        });
    </script>
</body>
</html>